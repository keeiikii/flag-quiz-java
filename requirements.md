# 国旗クイズゲーム (Java版) - 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト説明
国旗クイズゲームは、Java Spring Bootで構築されたインタラクティブなWebベースアプリケーションです。ユーザーは国旗を見て国名を当てるゲームを楽しめます。Google Gemini AI APIを活用して、インテリジェントな質問応答、ヒント生成、回答検証機能を提供し、魅力的な教育体験を創出します。

### 1.2 プロジェクト目標
- 教育的で楽しい国旗識別ゲームの作成
- Google Gemini AI APIとの統合実証
- モダンWeb技術を使用したレスポンシブWebインターフェース提供
- セッションベースのゲーム状態管理実装
- 日本語・英語両言語での入出力サポート

### 1.3 対象ユーザー
- 世界地理を学習する学生
- 教育機関
- 世界の知識に興味のある一般ユーザー
- AI API統合を学習するWeb開発者

## 2. ゲームルールと仕組み

### 2.1 基本ゲームルール
- **目的**: 国旗を見てその国名を特定する
- **回答試行**: 最大2回まで不正解可能
- **質問**: Yes/No形式で最大10回質問可能
- **ヒント**: 3種類のヒントが利用可能（各種類1回ずつ）
- **言語サポート**: 日本語・英語両方での回答受付
- **セッション持続時間**: 非アクティブ時30分でタイムアウト

### 2.2 ゲームフロー
1. **ゲーム初期化**: システムがランダムに国を選択し国旗を表示
2. **情報収集フェーズ**: 
   - プレイヤーはYes/No質問を最大10回可能
   - プレイヤーは最大3種類のヒントを要求可能
3. **回答提出**: プレイヤーが国名予想を提出
4. **結果評価**: システムが回答を検証しフィードバック提供
5. **ゲーム終了**: 正解時または試行回数終了時にゲーム終了

### 2.3 ヒントシステム
- **主食**: その国の主要な食材について
- **面積**: 日本との面積比較
- **言語**: 公用語に関する情報
- 各ヒント種類はゲームセッション中1回のみ使用可能
- ヒント回答では国名が明かされてはならない

## 3. 技術アーキテクチャ

### 3.1 技術スタック
- **バックエンドフレームワーク**: Spring Boot 3.2.0
- **Java バージョン**: Java 17
- **テンプレートエンジン**: Thymeleaf
- **HTTPクライアント**: OkHttp 4.12.0
- **ビルドツール**: Maven
- **AI統合**: Google Gemini 2.0 Flash Experimental API
- **設定管理**: dotenv-java 3.0.0
- **セッション管理**: Spring Session (インメモリ)

### 3.2 アプリケーションアーキテクチャ
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   プレゼン       │    │    ビジネス     │    │   外部          │
│   テーション層   │    │    ロジック層   │    │   サービス      │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ GameController  │ -> │ GameService     │ -> │ GeminiService   │
│ ErrorController │    │                 │    │                 │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ Thymeleaf       │    │ GameState       │    │ Gemini API      │
│ Templates       │    │ Model           │    │ flagcdn.com     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.3 パッケージ構造
```
com.example.flagquiz/
├── FlagQuizApplication.java        # メインアプリケーションエントリーポイント
├── controller/
│   ├── GameController.java         # ゲームロジックエンドポイント
│   └── CustomErrorController.java  # エラーハンドリング
├── service/
│   ├── GameService.java           # ゲームビジネスロジック
│   └── GeminiService.java         # AI API統合
├── model/
│   └── GameState.java             # ゲーム状態データモデル
└── config/
    └── DotEnvConfig.java          # 環境設定
```

## 4. API仕様

### 4.1 Webエンドポイント

#### 4.1.1 ゲームインターフェース
- **GET /** - メインゲームインターフェース
  - 戻り値: 現在の状態を持つゲームページ
  - テンプレート: `index.html`
  - セッション: 存在する場合は`gameState`を取得

#### 4.1.2 ゲームアクション
- **POST /new_game** - 新しいゲームセッション初期化
  - アクション: 新しいGameState作成、ランダム国選択
  - リダイレクト: 成功メッセージ付きでメインページに戻る
  - エラーハンドリング: 失敗時はエラーメッセージ表示

- **POST /ask_question** - Yes/No質問提出
  - パラメータ: `question` (文字列)
  - 検証: 質問形式と残り試行回数
  - 応答: AI生成のYes/No回答
  - 副作用: 質問回数減算、やり取りログ記録

- **POST /get_hint** - ヒント要求
  - パラメータ: `hintType` (文字列: "主食", "面積", "言語")
  - 検証: ヒント利用可能性と種類の妥当性
  - 応答: 国名を含まないAI生成ヒント
  - 副作用: ヒントを使用済みとしてマーク、ヒント回数減算

- **POST /submit_answer** - 国名予想提出
  - パラメータ: `answer` (文字列)
  - 検証: 回答形式と残り試行回数
  - 応答: 正解/不正解フィードバックと残り試行回数
  - 副作用: 不正解時に回答回数減算

### 4.2 Gemini API統合

#### 4.2.1 API設定
- **ベースURL**: `https://generativelanguage.googleapis.com/v1beta/models/`
- **モデル**: `gemini-2.0-flash-exp`
- **認証**: クエリパラメータ経由のAPIキー
- **コンテンツタイプ**: `application/json`

#### 4.2.2 APIメソッド

##### 国生成
```json
{
  "contents": [{
    "parts": [{
      "text": "世界の国連加盟国から1つの国をランダムに選んで、以下の形式で回答してください：\n国名（英語）: [英語の正式名称]\n国名（日本語）: [日本語の国名]\n国旗URL: https://flagcdn.com/w640/[2文字の国コード].png"
    }]
  }]
}
```

##### 質問回答
```json
{
  "contents": [{
    "parts": [{
      "text": "質問: \"[USER_QUESTION]\"\n対象国: [COUNTRY]\n\nこの国について上記の質問にYesまたはNoで回答してください。"
    }]
  }]
}
```

##### ヒント生成
```json
{
  "contents": [{
    "parts": [{
      "text": "[COUNTRY]の[HINT_TYPE]について教えてください。国名は絶対に言及しないでください。"
    }]
  }]
}
```

##### 回答検証
```json
{
  "contents": [{
    "parts": [{
      "text": "ユーザーの回答: \"[USER_ANSWER]\"\n正解の国（英語）: [ENGLISH_NAME]\n正解の国（日本語）: [JAPANESE_NAME]\n\nユーザーの回答が正解かどうかを判定してください。正解の場合は「正解」、不正解の場合は「不正解」のみ回答してください。"
    }]
  }]
}
```

## 5. データモデル

### 5.1 GameStateモデル
```java
public class GameState {
    private String currentCountryEnglish;     // 英語での国名
    private String currentCountryJapanese;    // 日本語での国名
    private String countryFlag;               // 国旗画像URL
    private int answersLeft = 2;              // 残り回答試行回数
    private int questionsLeft = 10;           // 残り質問回数
    private int hintsLeft = 3;                // 残りヒント回数
    private List<String> hintsUsed;           // 使用済みヒント種類
    private List<String> gameLog;             // 質問-回答履歴
    // ... ゲッター・セッター
}
```

### 5.2 セッション管理
- **ストレージ**: HTTPセッション（インメモリ）
- **キー**: `gameState`
- **タイムアウト**: 30分
- **スコープ**: 単一ブラウザセッション

## 6. 外部サービス依存関係

### 6.1 Google Gemini API
- **目的**: AI駆動のゲームロジック
- **認証**: APIキー
- **レート制限**: Googleの利用規約に従う
- **フォールバック**: API利用不可時の基本的なハードコード回答
- **エラーハンドリング**: フォールバック回答による優雅な劣化

### 6.2 国旗画像サービス
- **提供者**: flagcdn.com
- **形式**: PNG画像
- **解像度**: 640px幅 (w640)
- **URLパターン**: `https://flagcdn.com/w640/[country-code].png`
- **利用可能性**: パブリックCDN、認証不要

## 7. 設定要件

### 7.1 環境変数
```bash
# 必須
GEMINI_API_KEY=your-actual-gemini-api-key-here

# オプション（デフォルト値あり）
GEMINI_MODEL=gemini-2.0-flash-exp
SERVER_PORT=8080
```

### 7.2 アプリケーションプロパティ
```properties
# アプリケーション
spring.application.name=flag-quiz-jv
server.port=8080

# セッション管理
server.servlet.session.timeout=30m
server.servlet.session.cookie.max-age=1800

# Thymeleafテンプレートエンジン
spring.thymeleaf.cache=false
spring.thymeleaf.mode=HTML
spring.thymeleaf.encoding=UTF-8

# 文字エンコーディング
server.servlet.encoding.charset=UTF-8
server.servlet.encoding.enabled=true
server.servlet.encoding.force=true

# ログ
logging.level.com.example.flagquiz=DEBUG

# エラーハンドリング
server.error.include-message=always
server.error.include-binding-errors=always
server.error.include-stacktrace=always

# Gemini API
gemini.api.key=${GEMINI_API_KEY}
gemini.model=gemini-2.0-flash-exp
```

## 8. ユーザーインターフェース要件

### 8.1 レイアウト構造
- **レスポンシブデザイン**: モバイル・デスクトップ対応
- **2カラムレイアウト**: 
  - 左: 国旗表示、ゲーム状態、ヒント
  - 右: 質問、回答、インタラクションフォーム
- **配色**: モダンでアクセシブルなカラーパレット
- **タイポグラフィ**: 適切なコントラストを持つ明瞭で読みやすいフォント

### 8.2 UIコンポーネント

#### 8.2.1 ゲーム状態パネル
- 残り試行回数表示（回答、質問、ヒント）
- 視覚的な進行状況インジケーター
- 明確な状態メッセージとフィードバック

#### 8.2.2 国旗表示
- 大きく明瞭な国旗画像
- レスポンシブサイジング
- アクセシビリティ用alt テキスト

#### 8.2.3 インタラクションフォーム
- プレースホルダーテキスト付き質問入力
- 無効化状態を持つヒント要求ボタン
- 回答提出フォーム
- フォーム検証とエラー表示

#### 8.2.4 メッセージシステム
- 成功メッセージ（緑）
- エラーメッセージ（赤）
- 情報メッセージ（青）
- 一時的なフラッシュメッセージ

### 8.3 ユーザーエクスペリエンスフロー
1. **ランディング**: 明確な「新しいゲームを開始」ボタン
2. **ゲーム中**: すべてのコントロールにアクセス可能、状態表示
3. **フィードバック**: すべてのアクションに対する即座の応答
4. **ゲーム終了**: 明確な成功/失敗表示
5. **リセット**: 簡単な再開機能

## 9. セキュリティ要件

### 9.1 入力検証
- **質問テキスト**: 非空、適切な長さ制限
- **回答テキスト**: 非空、空白文字トリミング
- **ヒント種類**: 許可された値との照合検証
- **XSS防止**: Thymeleafの自動エスケープ有効

### 9.2 APIセキュリティ
- **APIキー**: 環境変数での保存
- **リクエスト検証**: すべてのGemini APIリクエストの検証
- **エラーハンドリング**: エラーメッセージでの機密情報非開示
- **レート制限**: APIプロバイダーの制限尊重

### 9.3 セッションセキュリティ
- **セッションタイムアウト**: 30分の非アクティブタイムアウト
- **セッション分離**: セッション毎のゲーム状態
- **永続ストレージなし**: ゲームデータの永続的保存なし

## 10. パフォーマンス要件

### 10.1 応答時間
- **ページロード**: 初期ロード2秒未満
- **ゲームアクション**: API依存アクション5秒未満
- **静的コンテンツ**: キャッシュされたリソース500ms未満

### 10.2 スケーラビリティ
- **同時ユーザー**: 適度な同時利用サポート
- **メモリ使用**: 効率的なセッション管理
- **API効率**: 不要なAPI呼び出しの最小化

### 10.3 信頼性
- **稼働時間**: 運用時間中99%の可用性
- **エラー回復**: APIエラーの優雅な処理
- **フォールバック機能**: APIなしでの基本機能

## 11. テスト要件

### 11.1 単体テスト
- **サービス層**: GameServiceとGeminiServiceメソッド
- **モデル検証**: GameStateデータ整合性
- **ユーティリティ機能**: 解析と検証ロジック

### 11.2 統合テスト
- **コントローラーエンドポイント**: すべてのHTTPエンドポイント
- **セッション管理**: ゲーム状態の永続化
- **テンプレートレンダリング**: Thymeleafテンプレート処理

### 11.3 システムテスト
- **完全ゲームフロー**: フルゲームシナリオ
- **エラーシナリオ**: API失敗、無効入力
- **ブラウザ互換性**: 主要ブラウザサポート

## 12. デプロイ要件

### 12.1 実行環境
- **Java ランタイム**: Java 17以上
- **アプリケーションサーバー**: 組み込みTomcat（Spring Boot）
- **オペレーティングシステム**: クロスプラットフォーム（Windows、Linux、macOS）
- **メモリ**: 最小512MB RAM

### 12.2 ビルド要件
- **ビルドツール**: Apache Maven 3.6+
- **依存関係**: pom.xmlで指定されたすべて
- **ビルドコマンド**: `mvn clean package`
- **実行コマンド**: `mvn spring-boot:run` または `java -jar target/flag-quiz-jv-0.0.1-SNAPSHOT.jar`

### 12.3 環境セットアップ
```bash
# 1. プロジェクトのクローン/展開
# 2. 環境変数の設定
echo "GEMINI_API_KEY=your-key-here" > .env

# 3. ビルドと実行
mvn clean package
mvn spring-boot:run

# 4. アプリケーションへのアクセス
# http://localhost:8080
```

### 12.4 本番環境での考慮事項
- **ログ**: 適切なログレベルの設定
- **監視**: ヘルスチェックエンドポイント
- **設定**: 外部化された設定ファイル
- **セキュリティ**: 本番環境でのHTTPS

## 13. メンテナンスとサポート

### 13.1 コードメンテナンス
- **コードスタイル**: Java命名規則に従う
- **ドキュメント**: すべてのpublicメソッドにJavadoc
- **バージョン管理**: 意味のあるコミットメッセージを持つGit
- **依存関係**: 定期的なセキュリティアップデート

### 13.2 運用サポート
- **ログ監視**: エラーログとアクセスログ
- **API監視**: Gemini API使用量と制限
- **パフォーマンス監視**: 応答時間とエラー
- **ユーザーフィードバック**: 収集と分析

### 13.3 将来の機能拡張
- **データベース統合**: 永続的なゲーム履歴
- **ユーザー認証**: 個人ゲーム統計
- **マルチプレイヤーモード**: 競争的ゲームプレイ
- **追加言語**: 多言語サポート
- **モバイルアプリ**: ネイティブモバイルアプリケーション

## 14. 品質保証

### 14.1 コード品質
- **静的解析**: SonarQubeなどのツール使用
- **コードカバレッジ**: 最低80%のテストカバレッジ
- **コードレビュー**: すべての変更に対するピアレビュー
- **スタイルガイド**: 一貫したコーディング標準

### 14.2 ユーザーエクスペリエンス品質
- **アクセシビリティ**: WCAG 2.1 AA準拠
- **ユーザビリティテスト**: 定期的なユーザーフィードバック
- **パフォーマンステスト**: 負荷・ストレステスト
- **クロスブラウザテスト**: 主要ブラウザ互換性

### 14.3 ドキュメント品質
- **API ドキュメント**: 完全なエンドポイントドキュメント
- **ユーザーガイド**: 明確な利用説明
- **開発者ガイド**: セットアップと開発手順
- **トラブルシューティング**: よくある問題と解決方法

---

## 付録A: APIレスポンス例

### A.1 Gemini国生成レスポンス
```
国名（英語）: France
国名（日本語）: フランス
国旗URL: https://flagcdn.com/w640/fr.png
```

### A.2 Gemini質問回答レスポンス
```
No
```

### A.3 Geminiヒントレスポンス
```
主食として小麦が多く使われ、パンやパスタが食卓の中心となっています。チーズとワインも食文化の重要な部分を占めています。
```

## 付録B: エラーハンドリングマトリックス

| エラー種類 | ユーザーメッセージ | システムアクション | 回復方法 |
|------------|--------------|---------------|----------|
| API失敗 | "サービスが一時的に利用できません" | フォールバック回答使用 | 次回リクエスト時に再試行 |
| 無効な質問 | "質問はYes/No形式で答えられる内容にしてください" | エラーメッセージ表示 | 新しい質問を許可 |
| 質問回数終了 | "質問回数が残っていません" | 質問フォーム無効化 | ゲーム継続 |
| ヒント回数終了 | "ヒントは3回まで使用できます" | ヒントボタン無効化 | ゲーム継続 |
| 回答回数終了 | "回答回数が残っていません" | ゲームオーバー表示 | 新しいゲーム提案 |
| セッションタイムアウト | "セッションが切れました" | ゲーム状態クリア | スタート画面にリダイレクト |

---

*この要件定義書は、国旗クイズゲーム Java Spring Bootアプリケーション用の包括的な仕様として機能します。プロジェクトの発展と新しい要件の特定により更新されるべきです。*